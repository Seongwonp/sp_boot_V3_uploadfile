<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>Add New Post</title>
</head>

<body>
<div class="container py-5" layout:fragment="content">
    <div class="col-md-8 mx-auto">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìù Create New Post</h5>
            </div>
            <div class="card-body">
                <form action="/board/add" method="post" enctype="application/x-www-form-urlencoded" novalidate>
                    <!-- Title Field -->
                    <div class="mb-3">
                        <label for="title" class="form-label fw-semibold">Title</label>
                        <input type="text" name="title" id="title" class="form-control" placeholder="Enter your post title">
                    </div>

                    <!-- Content Field -->
                    <div class="mb-3">
                        <label for="content" class="form-label fw-semibold">Content</label>
                        <textarea name="content" id="content" class="form-control" rows="6" placeholder="Write your post content here..."></textarea>
                    </div>

                    <!-- Writer Field -->
                    <div class="mb-3">
                        <label for="writer" class="form-label fw-semibold">Writer</label>
                        <input type="text" name="writer" id="writer" class="form-control" placeholder="Enter your name">
                    </div>

                    <!-- File Upload Field -->
                    <div class="mb-3">
                        <label for="fileUpload" class="form-label fw-semibold">Attach Files</label>
                        <input type="file" id="fileUpload" class="form-control" multiple>
                        <div id="uploadPreview" class="mt-2"></div>
                    </div>

                    <!-- Hidden Input: Uploaded File Names -->
                    <div id="uploadedFiles"></div>

                    <!-- Buttons -->
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="bi bi-check-circle-fill"></i> Submit
                        </button>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script layout:fragment="script" th:inline="javascript">
    const errors = [[${errors}]];
    if (errors && errors.length > 0) {
        let errorMessage = '';
        errors.forEach(err => {
            errorMessage += `${err.field}: ${err.defaultMessage}\n`;
        });
        alert(errorMessage);
    }

    // üîÅ Upload logic
    document.querySelector('#fileUpload').addEventListener('change', async (e) => {
        const files = e.target.files;
        const formData = new FormData();
        for (const file of files) {
            formData.append("files", file);
        }

        const res = await fetch("/api/file/upload", { method: "POST", body: formData });
        const result = await res.json(); // Expecting ["UUID_filename.ext", ...]

        const uploadedFilesDiv = document.getElementById("uploadedFiles");
        const previewDiv = document.getElementById("uploadPreview");
        uploadedFilesDiv.innerHTML = "";
        previewDiv.innerHTML = "";

        result.forEach(fileName => {
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "fileNames";
            hiddenInput.value = fileName;
            uploadedFilesDiv.appendChild(hiddenInput);

            const span = document.createElement("span");
            span.className = "badge bg-light text-dark me-1";
            span.textContent = fileName;
            previewDiv.appendChild(span);
        });
    });
</script>
</body>
</html>
